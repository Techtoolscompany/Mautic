{#
  Variables:
    - contacts
    - company
    - tmpl
    - permissions
    - security
    - page
    - limit
    - totalItems
#}
{% set baseUrl = path('mautic_company_contacts_list', {'objectId': company.id}) %}
{% set customButtons = [] %}

{% if permissions['lead:leads:editown'] or permissions['load:leads:editother'] %}
    {% set customButtons = [
        {
            'attr': {
                'class': 'btn btn-default btn-sm btn-nospin',
                'data-toggle': 'ajaxmodal',
                'data-target': '#MauticSharedModal',
                'href': path('mautic_segment_batch_contact_view'),
                'data-header': 'mautic.lead.batch.lists'|trans,
            },
            'btnText': 'mautic.lead.batch.lists'|trans,
            'iconClass': 'fa fa-pie-chart',
        },
        {
            'attr': {
                'class': 'btn btn-default btn-sm btn-nospin',
                'data-toggle': 'ajaxmodal',
                'data-target': '#MauticSharedModal',
                'href': path('mautic_contact_action', {'objectAction': 'batchStages'}),
                'data-header': 'mautic.lead.batch.stages'|trans,
            },
            'btnText': 'mautic.lead.batch.stages'|trans,
            'iconClass': 'fa fa-tachometer',
        },
        {
            'attr': {
                'class': 'btn btn-default btn-sm btn-nospin',
                'data-toggle': 'ajaxmodal',
                'data-target': '#MauticSharedModal',
                'href': path('mautic_contact_action', {'objectAction': 'batchCampaigns'}),
                'data-header': 'mautic.lead.batch.campaigns'|trans,
            },
            'btnText': 'mautic.lead.batch.campaigns'|trans,
            'iconClass': 'fa fa-clock-o',
        },
        {
            'attr': {
                'class': 'btn btn-default btn-sm btn-nospin',
                'data-toggle': 'ajaxmodal',
                'data-target': '#MauticSharedModal',
                'href': path('mautic_contact_action', {'objectAction': 'batchOwners'}),
                'data-header': 'mautic.lead.batch.owner'|trans,
            },
            'btnText': 'mautic.lead.batch.owner'|trans,
            'iconClass': 'fa fa-user',
        },
        {
            'attr': {
                'class': 'btn btn-default btn-sm btn-nospin',
                'data-toggle': 'ajaxmodal',
                'data-target': '#MauticSharedModal',
                'href': path('mautic_contact_action', {'objectAction': 'batchDnc'}),
                'data-header': 'mautic.lead.batch.dnc'|trans,
            },
            'btnText': 'mautic.lead.batch.dnc'|trans,
            'iconClass': 'fa fa-ban text-danger',
        },
    ] %}
{% endif %}

{% if contacts|length > 0 %}
    <div class="table-responsive">
        <table class="table table-hover table-striped table-bordered" id="leadTable">
            <thead>
                <tr>
                    {{ include('MauticCoreBundle:Helper:tableheader.html.twig', {
                        'checkall': 'true',
                        'target': '#contacts-table',
                        'templateButtons': {
                            'delete': permissions['lead:leads:deleteown'] or permissions['lead:leads:deleteother'],
                        },
                        'customButtons': customButtons,
                        'langVar': 'lead.lead',
                        'routeBase': 'contact',
                        'tooltip': 'mautic.lead.list.checkall.help'|trans,
                    }) }}
                    {{ include('MauticCoreBundle:Helper:tableheader.html.twig', {
                        'sessionVar': 'company.'~company.id~'.contacts',
                        'orderBy': 'l.lastname, l.firstname, l.company, l.email',
                        'text': 'mautic.core.name',
                        'class': 'col-lead-name',
                        'target': '#contacts-table',
                        'baseUrl': baseUrl,
                    }) }}
                    {{ include('MauticCoreBundle:Helper:tableheader.html.twig', {
                        'sessionVar': 'company.'~company.id~'.contacts',
                        'orderBy': 'l.email',
                        'text': 'mautic.core.type.email',
                        'class': 'col-lead-email visible-md visible-lg',
                        'target': '#contacts-table',
                        'baseUrl': baseUrl,
                    }) }}
                    {{ include('MauticCoreBundle:Helper:tableheader.html.twig', {
                        'sessionVar': 'company.'~company.id~'.contacts',
                        'orderBy': 'l.city, l.state',
                        'text': 'mautic.lead.lead.thead.location',
                        'class': 'col-lead-location visible-md visible-lg',
                        'target': '#contacts-table',
                        'baseUrl': baseUrl,
                    }) }}
                    {{ include('MauticCoreBundle:Helper:tableheader.html.twig', {
                        'sessionVar': 'company.'~company.id~'.contacts',
                        'orderBy': 'l.stage_id',
                        'text': 'mautic.lead.stage.label',
                        'class': 'col-lead-stage',
                        'target': '#contacts-table',
                        'baseUrl': baseUrl,
                    }) }}
                    {{ include('MauticCoreBundle:Helper:tableheader.html.twig', {
                        'sessionVar': 'company.'~company.id~'.contacts',
                        'orderBy': 'l.points',
                        'text': 'mautic.lead.points',
                        'class': 'visible-md visible-lg col-lead-points',
                        'target': '#contacts-table',
                        'baseUrl': baseUrl,
                    }) }}
                    {{ include('MauticCoreBundle:Helper:tableheader.html.twig', {
                        'sessionVar': 'company.'~company.id~'.contacts',
                        'orderBy': 'l.last_active',
                        'text': 'mautic.lead.lastactive',
                        'class': 'col-lead-lastactive visible-md visible-lg',
                        'default': true,
                        'target': '#contacts-table',
                        'baseUrl': baseUrl,
                    }) }}
                    {{ include('MauticCoreBundle:Helper:tableheader.html.twig', {
                        'sessionVar': 'company.'~company.id~'.contacts',
                        'orderBy': 'l.id',
                        'text': 'mautic.core.id',
                        'class': 'col-lead-id visible-md visible-lg',
                        'target': '#contacts-table',
                        'baseUrl': baseUrl,
                    }) }}
                </tr>
            </thead>
            <tbody>
            {% for contact in contacts %}
                <?php $fields = $contact->getFields(); ?>
                {% set fields = contact.fields %}
                <tr>
                    <td>
                        {% set hasEditAccess = securityHasEntityAccess(permissions['lead:leads:editown'], permissions['lead:leads:editother'], contact.permissionUser()) %}
                        {% set custom = [] %}
                        {% if hasEditAccess and currentList is defined %}
                            {# this lead was manually added to a list so give an option to remove them #}
                            {% set custom = custom|merge([{
                                'attr': {
                                    'href': path('mautic_segment_action', {'objectAction': 'removeLead', 'objectId': currentList.id, 'leadId': contact.id}),
                                    'data-toggle': 'ajax',
                                    'data-method': 'POST',
                                },
                                'btnText': 'mautic.lead.lead.remove.fromlist',
                                'iconClass': 'fa fa-remove',
                            }]) %}
                        {% endif %}

                        if (!empty($fields['core']['email']['value'])) {
                            $custom[] = [
                                'attr' => [
                                    'data-toggle' => 'ajaxmodal',
                                    'data-target' => '#MauticSharedModal',
                                    'data-header' => $view['translator']->trans('mautic.lead.email.send_email.header', ['%email%' => $fields['core']['email']['value']]),
                                    'href'        => $view['router']->path('mautic_contact_action', ['objectId' => $contact->getId(), 'objectAction' => 'email', 'list' => 1]),
                                ],
                                'btnText'   => 'mautic.lead.email.send_email',
                                'iconClass' => 'fa fa-send',
                            ];
                        }

                        {{ include('MauticCoreBundle:Helper:list_actions.html.twig', {
                            'item': contact,
                            'templateButtons': {
                                'edit': hasEditAccess,
                                'delete': securityHasEntityAccess(permissions['lead:leads:deleteown'], permissions['lead:leads:deleteother'], contact.permissionUser),
                            },
                            'routeBase': 'contact',
                            'langVar': 'lead.lead',
                            'customButtons': custom,
                        }) }}
                    </td>
                    <td>
                        <a href="{{ path('mautic_contact_action', {'objectAction': 'view', 'objectId': contact.id}) }}" data-toggle="ajax">
                            <div>{% if contact.isAnonymous %}{{ contact.primaryIdentifier|trans }}{% else %}{{ contact.primaryIdentifier|purify }}{% endif %}</div>
                            <div class="small">{{ contact.secondaryIdentifier|purify }}</div>
                        </a>
                    </td>
                    <td class="visible-md visible-lg">{{ fields.core.email.value|purify }}</td>
                    <td class="visible-md visible-lg">
                        $flag = (!empty($fields['core']['country'])) ? $view['assets']->getCountryFlag($fields['core']['country']['value']) : '';
                        if (!empty($flag)) :
                          <img src="<?php echo $flag; ?>" style="max-height: 24px;" class="mr-sm" />
                        endif;
                        $location = [];
                        if (!empty($fields['core']['city']['value'])) :
                            $location[] = $fields['core']['city']['value'];
                        endif;
                        if (!empty($fields['core']['state']['value'])) :
                            $location[] = $fields['core']['state']['value'];
                        elseif (!empty($fields['core']['country']['value'])) :
                            $location[] = $fields['core']['country']['value'];
                        endif;
                        echo $view->escape(implode(', ', $location));
                        <div class="clearfix"></div>
                    </td>
                    <td class="text-center">
                        $color = $contact->getColor();
                        $style = !empty($color) ? ' style="background-color: '.$color.';"' : '';
                        <?php if ($contact->getStage()) :?>
                          <span class="label label-default"<?php echo $style; ?>><?php echo $view->escape($contact->getStage()->getName()); ?></span>
                        <?php endif; ?>
                    </td>
                    <td class="visible-md visible-lg text-center">
                        $color = $contact->getColor();
                        $style = !empty($color) ? ' style="background-color: '.$color.';"' : '';
                        <span class="label label-default"<?php echo $style; ?>><?php echo $contact->getPoints(); ?></span>
                    </td>
                    <td class="visible-md visible-lg">
                        <abbr title="<?php echo $view['date']->toFull($contact->getLastActive()); ?>">
                            <?php echo $view['date']->toText($contact->getLastActive()); ?>
                        </abbr>
                    </td>
                    <td class="visible-md visible-lg">{{ contact.id }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    {{ include('MauticCoreBundle:Helper:pagination.html.twig', {
            'page': page,
            'limit': limit,
            'baseUrl': baseUrl,
            'target': '#contacts-table',
            'totalItems': totalItems,
            'sessionVar': 'company.'~company.id~'.contacts',
    }) }}
{% else %}
    {{ include('MauticCoreBundle:Helper:noresults.html.twig') }}
{% endif %}
