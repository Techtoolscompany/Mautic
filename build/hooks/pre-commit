#!/usr/bin/env bash

ROOT=$(git rev-parse --show-toplevel)

echo "php-cs-fixer and rector pre commit hook start"

PHP_CS_FIXER="bin/php-cs-fixer"
HAS_PHP_CS_FIXER=false

if [ -x $PHP_CS_FIXER ]; then
    HAS_PHP_CS_FIXER=true
fi

RECTOR="bin/rector"
HAS_RECTOR=false

if [ -x $RECTOR ]; then
    HAS_RECTOR=true
fi

# Get staged PHP files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.php$')

if $HAS_PHP_CS_FIXER && [ ! -z "$STAGED_FILES" ]; then
    # Fix changed (indexed) PHP files with php-cs-fixer
    $PHP_CS_FIXER fix --config=$ROOT/.php-cs-fixer.php --verbose --using-cache=no $STAGED_FILES
fi

if $HAS_RECTOR && [ ! -z "$STAGED_FILES" ]; then
    # Refactor changed (indexed) PHP files with Rector
    $RECTOR process $STAGED_FILES --config $ROOT/rector.php
fi

# Add the changes from CS Fixer and Rector back to the git index:
git add $STAGED_FILES

if ! $HAS_PHP_CS_FIXER; then
    echo ""
    echo "Please install php-cs-fixer, e.g.:"
    echo ""
    echo "  composer require --dev friendsofphp/php-cs-fixer"
    echo ""
fi

if ! $HAS_RECTOR; then
    echo ""
    echo "Please install Rector, e.g.:"
    echo ""
    echo "  composer require --dev rector/rector"
    echo ""
fi

echo "php-cs-fixer and rector pre commit hook finish"
